{% extends "../base.html" %}
{% load i18n %}
{% block title %}{% trans "Chat room" %}{% endblock %}
{% block content %}
<div id="container-chatbot">
    <div id="chat"></div>
    <div class="chat-input d-grid gap-3">
        <input id="chat-message-input my-5" type="text" class="form-control" placeholder="your message to bot"
            aria-label="your message to bot" aria-describedby="addon-wrapping">
        <button id="chat-message-submit" type="submit" class="btn btn-primary">Send</button>
    </div>
</div>
{% endblock %}

{% block include_js %}
{{ request.user.username|json_script:"request-user" }}
{% endblock %}

{% block domready %}
const requestUser = JSON.parse(
document.getElementById('request-user').textContent
)

const url = 'ws://' + window.location.host + '/ws/chatbot/room/'
const chatSocket = new WebSocket(url)

chatSocket.onmessage = (event) => {
const data = JSON.parse(event.data)
const chat = document.querySelector("#chat")
const source = requestUser ? 'me' : 'other'
const name = requestUser ? 'Me' : 'GPT-bot'

chat.innerHTML += '<div class="message ' + source + '">' +
    '<strong>' + name + '</strong><br>' +
    data.message + '</div>';
chat.scrollTop = chat.scrollHeight;
}

chatSocket.onclose = (event) => {
console.error('Chat socket closed unexpectedly')
}

//sending message to the WebSocket
const input = document.getElementById('chat-message-input')
const submitButton = document.getElementById('chat-message-submit')

submitButton.addEventListener('click', (event) => {
const message = input.value
if(message){
//send message in JSON format
chatSocket.send(JSON.stringify({
'message': message
}))

//clear input
input.value = '';
input.focus();

}
})

input.addEventListener('keypress', (event) => {
if(event.key === 'Enter'){
//cancel the default action, if needed
event.preventDefault();
//trigger click event on button
submitButton.click();
}
});

input.focus();
{% endblock %}